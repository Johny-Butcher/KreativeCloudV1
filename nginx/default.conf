server {
    listen 80;
    server_name cloudv1.johny.codes;
    client_max_body_size 64M;

    # ===== Serve local projects directory =====
    location /projects/ {
        alias /var/www/projects/;
        index index.php index.html index.htm;
        autoindex off;

        # This handles the basic routing for both HTML and WordPress
        # It looks for the file, then the directory, then passes to index.php
        try_files $uri $uri/ /index.php?$args;

        # Handle PHP files anywhere inside the nested structure
        location ~ \.php$ {
            # This regex captures the path after /projects/
            fastcgi_split_path_info ^/projects/(.+\.php)(/.+)$;
            
            fastcgi_pass php_fpm:9000;
            fastcgi_index index.php;
            include fastcgi_params;

            # Using $request_filename is critical here!
            # It maps the Nginx 'alias' path directly to the disk path 
            # so PHP-FPM knows exactly where the file is.
            fastcgi_param SCRIPT_FILENAME $request_filename;
            
            # Cloudflare/HTTPS Support
            fastcgi_param HTTPS on;
        }
    }

    location /pma/ {
    proxy_pass http://hosting_pma:80/;
    
    # Critical Headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    
    # Force the protocol to HTTPS for the backend
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Port 443;

    # This is the "magic" line for Apache/PHP containers
    proxy_set_header HTTPS on;

    # Ensure cookies are rewritten to be "Secure"
    proxy_cookie_path / /;
    proxy_hide_header Vary;
    }

    # ===== Frontend (default) =====
    location / {
        proxy_pass http://frontend:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

server {
    listen 80;
    server_name cloudv1api.johny.codes;

    location / {
        proxy_pass http://api:3000/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}